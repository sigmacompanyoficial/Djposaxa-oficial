<!DOCTYPE html>
<html lang="ca">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panell d'Administració — DJ Posaxa</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Premium Styles -->
  <link rel="stylesheet" href="assets/css/premium-index.css">
  <link rel="icon" type="image/png" href="Fotos/dj-posaxa-logo.png">

  <style>
    /* Custom Dashboard Styles overrides */
    .kpi-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 1.5rem;
      text-align: center;
      height: 100%;
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease;
    }

    .kpi-card:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.08);
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 1.5rem;
      height: 100%;
    }

    .admin-table-container {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 2rem;
      overflow: hidden;
    }

    .table-dark {
      --bs-table-bg: transparent;
    }
  </style>
  <meta property="og:image" content="https://sigmacompanyoficial.github.io/Djposaxa-oficial/Fotos/dj-posaxa-logo.png">
</head>

<body class="is-loading">

  <div class="cursor"></div>
  <div class="cursor-follower"></div>

  <!-- Navbar -->
  <nav class="nav">
    <div class="nav-logo">
      <a href="index.html">
        <img src="Fotos/dj-posaxa-logo.png" alt="Dj Posaxa Logo" style="height: 50px;">
      </a>
    </div>
    <div class="nav-links d-none d-lg-flex">
      <a href="index.html">Inici</a>
      <a href="mashups.html">Mashups</a>
      <a href="configuracio.html"><i class="bi bi-gear-fill"></i></a>
      <div id="auth-container"></div>
      <div id="admin-link-container"></div>
    </div>
    <button class="navbar-toggler d-lg-none text-white" type="button" data-bs-toggle="collapse"
      data-bs-target="#mobileNav">
      <i class="bi bi-list fs-1"></i>
    </button>
  </nav>

  <div id="smooth-wrapper">
    <div id="smooth-content">

      <!-- Hero Section -->
      <section class="hero" data-color="dark">
        <div class="hero-bg" style="background-image: url('Fotos/dj-posaxa-sessio-inici-1.jpg'); opacity: 0.3;">
    <img src="Fotos/dj-posaxa-sessio-inici-1.jpg" alt="Dj Posaxa Sessio Inici 1" class="visually-hidden" loading="lazy"></div>
        <div class="hero-content">
          <h1 class="hero-title">Panell d'Admin</h1>
          <div class="hero-subtitle">
            <p>Benvingut, administrador. Gestió total de l'ecosistema DJ Posaxa.</p>
          </div>
        </div>
      </section>

      <!-- Main Content -->
      <section class="content-block" data-color="dark" style="padding: 4rem 0;">
        <div class="container">

          <!-- KPIs -->
          <div class="row g-4 mb-5 scroll-reveal">
            <div class="col-lg-2 col-md-4 col-6">
              <div class="kpi-card">
                <h6 class="text-white-50 text-uppercase ls-1" style="font-size: 0.7rem;">Total Usuaris</h6>
                <p class="display-6 fw-bold text-white mb-0" id="total-users-kpi">0</p>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
              <div class="kpi-card">
                <h6 class="text-white-50 text-uppercase ls-1" style="font-size: 0.7rem;">Actius (7d)</h6>
                <p class="display-6 fw-bold text-success mb-0" id="active-users-kpi">0</p>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
              <div class="kpi-card">
                <h6 class="text-white-50 text-uppercase ls-1" style="font-size: 0.7rem;">Opinions Pendents</h6>
                <p class="display-6 fw-bold text-warning mb-0" id="pending-reviews-kpi">0</p>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
              <div class="kpi-card">
                <h6 class="text-white-50 text-uppercase ls-1" style="font-size: 0.7rem;">Seguidors Verificats</h6>
                <p class="display-6 fw-bold text-info mb-0" id="verified-followers-kpi">0</p>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
              <div class="kpi-card">
                <h6 class="text-white-50 text-uppercase ls-1" style="font-size: 0.7rem;">Rols Admin</h6>
                <p class="display-6 fw-bold text-danger mb-0" id="admin-roles-kpi">0</p>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
              <div class="kpi-card">
                <h6 class="text-white-50 text-uppercase ls-1" style="font-size: 0.7rem;">Descàrregues</h6>
                <p class="display-6 fw-bold text-white mb-0" id="total-downloads-kpi">0</p>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
              <div class="kpi-card">
                <h6 class="text-white-50 text-uppercase ls-1" style="font-size: 0.7rem;">Booking Requests</h6>
                <p class="display-6 fw-bold text-primary mb-0" id="booking-requests-kpi">0</p>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="row g-4 mb-5 scroll-reveal">
            <div class="col-lg-4">
              <div class="chart-container">
                <h5 class="mb-4 text-center text-white">Distribució de Rols</h5>
                <canvas id="rolesChart"></canvas>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="chart-container">
                <h5 class="mb-4 text-center text-white">Mashups Top</h5>
                <canvas id="mashupsChart"></canvas>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="chart-container">
                <h5 class="mb-4 text-center text-white">Gèneres</h5>
                <canvas id="genresChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Management Sections -->
          <div class="row g-5">
            <!-- Bookings -->
            <div class="col-12 scroll-reveal">
              <div class="admin-table-container">
                <h2 class="mb-4 text-white font-display">Sol·licituds de Contractació</h2>
                <div id="booking-requests-list" class="d-grid gap-3">
                  <!-- Populated via JS -->
                </div>
              </div>
            </div>

            <!-- Reviews -->
            <div class="col-12 scroll-reveal">
              <div class="admin-table-container">
                <h2 class="mb-4 text-white font-display">Gestió d'Opinions Pendents</h2>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover align-middle">
                    <thead>
                      <tr>
                        <th>Usuari</th>
                        <th>Opinió</th>
                        <th>Data</th>
                        <th>Accions</th>
                      </tr>
                    </thead>
                    <tbody id="pending-reviews-list">
                      <!-- Populated via JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Published Reviews (New Section) -->
            <div class="col-12 scroll-reveal">
              <div class="admin-table-container">
                <h2 class="mb-4 text-white font-display">Opinions Publicades</h2>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover align-middle">
                    <thead>
                      <tr>
                        <th>Usuari</th>
                        <th>Opinió</th>
                        <th>Data</th>
                        <th>Accions</th>
                      </tr>
                    </thead>
                    <tbody id="published-reviews-list"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Users -->
            <div class="col-12 scroll-reveal">
              <div class="admin-table-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h2 class="text-white font-display mb-0">Gestió d'Usuaris</h2>
                  <button id="export-csv-btn" class="btn-premium btn-sm px-3">Exportar CSV</button>
                </div>

                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover align-middle">
                    <thead>
                      <tr>
                        <th>Nom a Mostrar</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Segueix a DJ Posaxa</th>
                        <th>Mashups</th>
                        <th>Última Connexió</th>
                        <th>Accions</th>
                      </tr>
                    </thead>
                    <tbody id="user-list">
                      <!-- Populated via JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- Footer -->
      <!-- Footer -->
      <footer class="footer">
        <div class="container">
          <div class="row g-4">
            <div class="col-md-4">
              <h5 class="mb-3">DJ Posaxa</h5>
              <p class="mb-3" style="color: var(--text-secondary);">Música professional per a festes i esdeveniments a
                Granollers i Barcelona.</p>
              <div class="social-icons">
                <a href="https://www.tiktok.com/@djposaxa" target="_blank" rel="noopener" aria-label="TikTok">
                  <i class="bi bi-tiktok"></i>
                </a>
                <a href="https://www.instagram.com/dj.posaxa/" target="_blank" rel="noopener" aria-label="Instagram">
                  <i class="bi bi-instagram"></i>
                </a>
              </div>
            </div>
            <div class="col-md-4">
              <h5 class="mb-3">Enllaços Ràpids</h5>
              <ul class="list-unstyled">
                <li class="mb-2"><a href="index.html"
                    style="color: var(--text-secondary); text-decoration: none;">Inici</a>
                </li>
                <li class="mb-2"><a href="esdeveniments.html"
                    style="color: var(--text-secondary); text-decoration: none;">Esdeveniments</a></li>
                <li class="mb-2"><a href="opinionse486.html"
                    style="color: var(--text-secondary); text-decoration: none;">Opinions</a></li>
                <li class="mb-2"><a href="preus.html"
                    style="color: var(--text-secondary); text-decoration: none;">Preus</a>
                </li>
              </ul>
            </div>
            <div class="col-md-4">
              <h5 class="mb-3">Sigma Company</h5>
              <p class="mb-3" style="color: var(--text-secondary);" data-translate="footer_dev">Desenvolupat per Sigma
                Company</p>
              <p class="mb-2" style="color: var(--text-secondary);" data-translate="footer_more_projects">Més projectes:
              </p>
              <div class="social-icons">
                <a href="https://www.tiktok.com/@sigmacompanyoficial" target="_blank" rel="noopener"
                  aria-label="TikTok">
                  <i class="bi bi-tiktok"></i>
                </a>
                <a href="https://www.instagram.com/sigmacompanyoficial/" target="_blank" rel="noopener"
                  aria-label="Instagram">
                  <i class="bi bi-instagram"></i>
                </a>
                <a href="https://www.youtube.com/@SigmaCompanyOficial" target="_blank" rel="noopener"
                  aria-label="YouTube">
                  <i class="bi bi-youtube"></i>
                </a>
              </div>
            </div>
          </div>
          <hr style="border-color: rgba(255, 255, 255, 0.1); margin: 3rem 0 2rem;">
          <div class="row">
            <div class="col-md-6 text-center text-md-start">
              <p style="color: var(--text-secondary); margin: 0;">&copy; <span id="year"></span> DJ Posaxa. <span
                  data-translate="footer_rights">Tots els drets reservats.</span></p>
            </div>
            <div class="col-md-6 text-center text-md-end">
              <p style="color: var(--text-secondary); margin: 0;"><span data-translate="footer_location">Granollers ·
                  Barcelona</span></p>
            </div>
          </div>
        </div>
      </footer>

    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 10000;">
    <div id="notificationToast" class="toast bg-dark text-white border-secondary" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="toast-header bg-secondary text-white border-bottom border-dark">
        <strong class="me-auto" id="toast-title">Notificació</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-body">
        Missatge.
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
  <script src="https://unpkg.com/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>
  <script src="https://unpkg.com/split-type"></script>

  <script src="assets/js/premium-index.js"></script>

  <!-- Firebase Logic -->
  <script type="module">
    import { auth, database, ref, get, update, onValue, remove, set, onAuthStateChanged } from "./assets/js/firebase-config.js";

    function showToast(title, message) {
      document.getElementById('toast-title').innerText = title;
      document.getElementById('toast-body').innerText = message;
      const toast = new bootstrap.Toast(document.getElementById('notificationToast'));
      toast.show();
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        // Fetch Admin Status
        const userRef = ref(database, 'users/' + user.uid);
        get(userRef).then((userSnapshot) => {
          const userData = userSnapshot.val() || {};
          if (userSnapshot.exists() && (userData.role === 'administrador' || userData.role === 'admin')) {
            // Setup Admin UI
            document.getElementById('auth-container').innerHTML = `
              <a class="nav-link" href="perfil.html" aria-label="Perfil"><img src="${user.photoURL}" style="width: 28px; height: 28px; border-radius: 50%;" alt="User Profile"></a>
            `;
            // Add logout button programmatically to nav
            const logoutLink = document.createElement('a');
            logoutLink.className = "nav-link ms-2";
            logoutLink.href = "#";
            logoutLink.innerHTML = '<i class="bi bi-box-arrow-right text-danger"></i>';
            logoutLink.addEventListener('click', (e) => {
              e.preventDefault();
              auth.signOut().then(() => window.location.href = 'index.html');
            });
            document.getElementById('auth-container').appendChild(logoutLink);

            document.getElementById('admin-link-container').innerHTML = `<a class="nav-link active text-warning" href="admin.html">Admin Panel</a>`;

            // --- LOAD DATA & KPIs (Original Logic Preserved) ---
            const allUsersRef = ref(database, 'users');
            get(allUsersRef).then((allUsersSnapshot) => {
              const userList = document.getElementById('user-list');
              userList.innerHTML = '';

              let totalUsers = 0;
              let activeUsers = 0;
              let totalDownloads = 0;
              let verifiedFollowers = 0;
              // let newBookings = 0; // Handled separately
              const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
              const rolesCount = { administrador: 0, cliente: 0, altres: 0 };
              const mashupDownloadsCount = {};
              const genresCount = {};

              allUsersSnapshot.forEach((childSnapshot) => {
                const userId = childSnapshot.key;
                const userData = childSnapshot.val();
                const prefs = userData.preferences || {};
                const downloads = userData.downloads || {};

                totalUsers++;

                if (userData.lastLogin && new Date(userData.lastLogin).getTime() > sevenDaysAgo) {
                  activeUsers++;
                }

                if (prefs.djPosaxaFollowVerified === 'true') {
                  verifiedFollowers++;
                }

                let role = userData.role || 'cliente';
                if (role === 'admin') role = 'administrador';

                if (rolesCount[role] !== undefined) {
                  rolesCount[role]++;
                } else {
                  rolesCount.altres++;
                }

                const genre = userData.favoriteGenre || 'No especificat';
                genresCount[genre] = (genresCount[genre] || 0) + 1;

                const downloadCount = Object.keys(downloads).length;
                totalDownloads += downloadCount;
                Object.keys(downloads).forEach(mashupId => {
                  mashupDownloadsCount[mashupId] = (mashupDownloadsCount[mashupId] || 0) + 1;
                });

                const isVerified = prefs.djPosaxaFollowVerified === 'true';
                // Switch Style updated for Dark theme
                const verificationSwitch = `
                  <div class="form-check form-switch d-flex justify-content-center">
                    <input class="form-check-input manual-verify-switch" type="checkbox" role="switch" data-user-id="${userId}" ${isVerified ? 'checked' : ''} style="cursor: pointer;">
                  </div>
                `;

                const downloadedMashups = Object.keys(downloads).length > 0
                  ? Object.keys(downloads).join(', ')
                  : 'Cap';

                const lastLogin = userData.lastLogin ? new Date(userData.lastLogin).toLocaleString('ca-ES') : 'N/A';
                const isActive = userData.lastLogin && new Date(userData.lastLogin).getTime() > sevenDaysAgo;
                const activeIndicator = `<span class="badge rounded-pill" style="background-color: ${isActive ? '#28a745' : '#6c757d'}; width: 10px; height: 10px; display: inline-block; padding: 0;"></span>`;

                const roleSelector = `
                  <select class="form-select form-select-sm bg-dark text-white border-secondary role-selector" data-user-id="${userId}" ${userData.email === 'polsolanasramos@gmail.com' ? 'disabled' : ''}>
                    <option value="cliente" ${userData.role === 'cliente' ? 'selected' : ''}>Cliente</option>
                    <option value="administrador" ${(userData.role === 'administrador' || userData.role === 'admin') ? 'selected' : ''}>Admin</option>
                  </select>
                `;

                const row = `
                  <tr>
                    <td>${userData.displayName || 'N/A'}</td>
                    <td>${userData.email || 'N/A'}</td>
                    <td>${roleSelector}</td>
                    <td>${verificationSwitch}</td>
                    <td class="small text-white-50">${downloadedMashups}</td>
                    <td>${activeIndicator} ${lastLogin}</td>
                    <td><button class="btn btn-sm btn-outline-danger delete-user-btn" data-user-id="${userId}" data-user-email="${userData.email}" ${userData.email === 'polsolanasramos@gmail.com' ? 'disabled' : ''}><i class="bi bi-trash"></i></button></td>
                  </tr>`;
                userList.innerHTML += row;
              });

              document.getElementById('total-users-kpi').textContent = totalUsers;
              document.getElementById('active-users-kpi').textContent = activeUsers;
              document.getElementById('total-downloads-kpi').textContent = totalDownloads;
              document.getElementById('verified-followers-kpi').textContent = verifiedFollowers;
              document.getElementById('admin-roles-kpi').textContent = rolesCount.administrador || 0;

              // Initialize Charts
              if (typeof Chart !== 'undefined') {
                Chart.defaults.color = '#ccc';
                Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

                new Chart(document.getElementById('rolesChart'), {
                  type: 'doughnut',
                  data: {
                    labels: ['Administradors', 'Clients', 'Altres'],
                    datasets: [{
                      data: [rolesCount.administrador, rolesCount.cliente, rolesCount.altres],
                      backgroundColor: ['#0d6efd', '#6c757d', '#ffc107'],
                      borderWidth: 0
                    }]
                  },
                  options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } } }
                });

                const sortedMashups = Object.entries(mashupDownloadsCount).sort(([, a], [, b]) => b - a).slice(0, 10);
                new Chart(document.getElementById('mashupsChart'), {
                  type: 'bar',
                  data: {
                    labels: sortedMashups.map(item => item[0]),
                    datasets: [{
                      label: 'Descàrregues',
                      data: sortedMashups.map(item => item[1]),
                      backgroundColor: '#667eea',
                      borderRadius: 5
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                  }
                });

                new Chart(document.getElementById('genresChart'), {
                  type: 'pie',
                  data: {
                    labels: Object.keys(genresCount),
                    datasets: [{
                      data: Object.values(genresCount),
                      backgroundColor: ['#667eea', '#764ba2', '#f5576c', '#f093fb', '#4facfe', '#43e97b'],
                      borderWidth: 0
                    }]
                  },
                  options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } } }
                });
              }

              // Listeners (Role, Verify, Delete)
              document.querySelectorAll('.role-selector').forEach(selector => {
                selector.addEventListener('change', (event) => {
                  const userId = event.target.dataset.userId;
                  const newRole = event.target.value;
                  set(ref(database, `users/${userId}/role`), newRole)
                    .then(() => showToast('Èxit', `Rol actualitzat a ${newRole}.`))
                    .catch((error) => showToast('Error', error.message));
                });
              });

              document.querySelectorAll('.manual-verify-switch').forEach(switchEl => {
                switchEl.addEventListener('change', (event) => {
                  const userId = event.target.dataset.userId;
                  const isChecked = event.target.checked;
                  set(ref(database, `users/${userId}/preferences/djPosaxaFollowVerified`), isChecked ? 'true' : 'false')
                    .then(() => showToast('Èxit', `Estat de seguidor actualitzat.`))
                    .catch((error) => showToast('Error', error.message));
                });
              });

              document.querySelectorAll('.delete-user-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                  // Handle icon click vs button click
                  const btn = event.target.closest('button');
                  const userId = btn.dataset.userId;
                  const userEmail = btn.dataset.userEmail;

                  if (confirm(`Estàs segur que vols eliminar l'usuari ${userEmail}?`)) {
                    remove(ref(database, `users/${userId}`))
                      .then(() => {
                        showToast('Èxit', `Usuari eliminat.`);
                        setTimeout(() => location.reload(), 1000);
                      })
                      .catch((error) => showToast('Error', error.message));
                  }
                });
              });

              // CSV Export
              document.getElementById('export-csv-btn').addEventListener('click', () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = ["Nom", "Email", "Rol", "Verificat", "Ultima Connexio", "Mashups"];
                csvContent += headers.join(",") + "\r\n";

                allUsersSnapshot.forEach((childSnapshot) => {
                  const userData = childSnapshot.val();
                  const prefs = userData.preferences || {};
                  const downloads = userData.downloads || {};
                  const isVerified = prefs.djPosaxaFollowVerified === 'true' ? 'Si' : 'No';
                  const lastLogin = userData.lastLogin ? new Date(userData.lastLogin).toLocaleString('ca-ES') : 'N/A';
                  const downloadedMashups = Object.keys(downloads).join('; ') || 'Cap';

                  const row = [
                    `"${userData.displayName || 'N/A'}"`,
                    `"${userData.email || 'N/A'}"`,
                    `"${userData.role || 'cliente'}"`,
                    `"${isVerified}"`,
                    `"${lastLogin}"`,
                    `"${downloadedMashups}"`
                  ];
                  csvContent += row.join(",") + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `informe_usuaris_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              });
            });

            // --- Booking Requests ---
            const bookingRequestsRef = ref(database, 'booking-requests');
            onValue(bookingRequestsRef, (snapshot) => {
              const requestsList = document.getElementById('booking-requests-list');
              requestsList.innerHTML = '';
              let pendingRequests = 0;

              if (snapshot.exists()) {
                const requests = [];
                snapshot.forEach(childSnapshot => {
                  requests.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });

                requests.sort((a, b) => {
                  if (a.status === 'pending' && b.status !== 'pending') return -1;
                  if (a.status !== 'pending' && b.status === 'pending') return 1;
                  return new Date(b.submittedAt) - new Date(a.submittedAt);
                });

                requests.forEach(data => {
                  const bookingId = data.id;
                  if (data.status === 'pending') pendingRequests++;

                  const submittedDate = new Date(data.submittedAt).toLocaleString('ca-ES');
                  const eventDate = new Date(data.eventDate).toLocaleDateString('ca-ES');
                  const statusBadge = data.status === 'pending'
                    ? `<span class="badge bg-warning text-dark">${data.status}</span>`
                    : `<span class="badge bg-success">${data.status}</span>`;

                  const card = `
                            <div class="p-4 rounded mb-0" id="booking-card-${bookingId}" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1 text-white">${data.contactName} <span class="text-secondary mx-2">|</span> <span class="text-primary">${data.eventType}</span></h5>
                                        <p class="text-white-50 mb-0 small"><i class="bi bi-calendar-event me-2"></i>Esdeveniment: ${eventDate} <span class="mx-2">•</span> Sol·licitat: ${submittedDate}</p>
                                    </div>
                                    ${statusBadge}
                                </div>
                                <div class="collapse mt-3" id="details-${bookingId}">
                                    <div class="card card-body bg-dark border-secondary">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong class="text-info">Contacte:</strong> <br> ${data.contactPhone} <br> ${data.contactEmail || 'No email'}</p>
                                                <p><strong class="text-info">Detalls:</strong> <br> ${data.eventLocation} @ ${data.eventTime}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Assistents/Públic:</strong> ${data.attendees} / ${data.audience}</p>
                                                <p><strong>Durada:</strong> ${data.duration}h</p>
                                                <p><strong>Estil/Equip:</strong> ${data.musicStyle} / ${data.tech}</p>
                                                <p><strong>Comentaris:</strong> ${data.comments || '-'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#details-${bookingId}">Veure Detalls</button>
                                    ${data.status === 'pending' ? `<button class="btn btn-sm btn-success mark-contacted-btn" data-booking-id="${bookingId}"><i class="bi bi-check-lg me-1"></i>Marcar Contactat</button>` : ''}
                                </div>
                            </div>
                        `;
                  requestsList.innerHTML += card;
                });

                document.getElementById('booking-requests-kpi').textContent = pendingRequests;

                document.querySelectorAll('.mark-contacted-btn').forEach(btn => {
                  btn.addEventListener('click', (e) => {
                    const bookingId = e.target.closest('button').dataset.bookingId;
                    set(ref(database, `booking-requests/${bookingId}/status`), 'contacted')
                      .then(() => showToast('Èxit', 'Marcat com a contactat.'))
                      .catch((error) => showToast('Error', error.message));
                  });
                });
              } else {
                requestsList.innerHTML = '<p class="text-center text-white-50">No hi ha sol·licituds.</p>';
                document.getElementById('booking-requests-kpi').textContent = 0;
              }
            });

            // --- Pending Reviews ---
            const pendingReviewsRef = ref(database, 'reviews/pending');
            onValue(pendingReviewsRef, (snapshot) => {
              const reviewsList = document.getElementById('pending-reviews-list');
              const pendingCount = snapshot.size;
              document.getElementById('pending-reviews-kpi').textContent = pendingCount;
              reviewsList.innerHTML = '';

              if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                  const reviewId = childSnapshot.key;
                  const reviewData = childSnapshot.val();
                  const reviewDate = reviewData.createdAt ? new Date(reviewData.createdAt).toLocaleDateString() : 'N/A';

                  const row = `
                            <tr>
                                <td>${reviewData.userName || 'N/A'}</td>
                                <td class="text-white-50 small" style="max-width: 300px;">"${reviewData.text}"</td>
                                <td>${reviewDate}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-success approve-btn" data-id="${reviewId}"><i class="bi bi-check-lg"></i></button>
                                        <button class="btn btn-danger reject-btn" data-id="${reviewId}"><i class="bi bi-x-lg"></i></button>
                                    </div>
                                </td>
                            </tr>`;
                  reviewsList.innerHTML += row;
                });

                document.querySelectorAll('.approve-btn').forEach(button => {
                  button.addEventListener('click', () => {
                    const reviewId = button.closest('button').dataset.id;
                    get(ref(database, `reviews/pending/${reviewId}`)).then((snapshot) => {
                      if (snapshot.exists()) {
                        const reviewData = snapshot.val();
                        reviewData.status = 'published';
                        if (!reviewData.createdAt) reviewData.createdAt = Date.now();

                        set(ref(database, `reviews/published/${reviewId}`), reviewData).then(() => {
                          remove(ref(database, `reviews/pending/${reviewId}`));
                          showToast('Èxit', 'Publicada.');
                        });
                      }
                    });
                  });
                });
                document.querySelectorAll('.reject-btn').forEach(button => {
                  button.addEventListener('click', () => {
                    const reviewId = button.closest('button').dataset.id;
                    remove(ref(database, `reviews/pending/${reviewId}`)).then(() => showToast('Eliminada', 'Rebutjada.'));
                  });
                });

              } else {
                reviewsList.innerHTML = '<tr><td colspan="4" class="text-center text-white-50 p-4">Cap opinió pendent.</td></tr>';
              }
            });

            // --- Published Reviews Logic ---
            const publishedReviewsRef = ref(database, 'reviews/published');
            onValue(publishedReviewsRef, (snapshot) => {
              const list = document.getElementById('published-reviews-list');
              list.innerHTML = '';
              if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                  const reviewId = childSnapshot.key;
                  const data = childSnapshot.val();
                  const date = data.createdAt ? new Date(data.createdAt).toLocaleDateString() : 'N/A';
                  const row = `
                    <tr>
                      <td>${data.userName}</td>
                      <td class="text-white-50 small" style="max-width: 300px;">"${data.text}"</td>
                      <td>${date}</td>
                      <td><button class="btn btn-sm btn-outline-danger delete-published-btn" data-id="${reviewId}"><i class="bi bi-trash"></i></button></td>
                    </tr>`;
                  list.innerHTML += row;
                });
                document.querySelectorAll('.delete-published-btn').forEach(btn => {
                  btn.addEventListener('click', (e) => {
                    const id = e.target.closest('button').dataset.id;
                    if (confirm('Esborrar aquesta opinió pública?')) remove(ref(database, `reviews/published/${id}`));
                  });
                });
              } else {
                list.innerHTML = '<tr><td colspan="4" class="text-center text-white-50">Cap opinió publicada.</td></tr>';
              }
            });

          } else {
            console.warn("Restricted Access");
            window.location.href = 'index.html';
          }
        }).catch(err => {
          console.error(err);
          window.location.href = 'index.html';
        });
      } else {
        window.location.href = 'index.html';
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>

</html>