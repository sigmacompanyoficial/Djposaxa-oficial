<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-translate="page_title">El Meu Perfil — DJ Posaxa</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PM90QK9QJX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-PM90QK9QJX');
  </script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="assets/css/modern-style.css" />
  <link rel="icon" type="image/png" href="Fotos/ChatGPT Image 20 d’ag. del 2025, 21_45_57.png">
</head>
<body onload="applyTheme()">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="Fotos/ChatGPT Image 20 d’ag. del 2025, 21_45_57.png" alt="DJ Posaxa Logo">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html" data-translate="nav_home">Inici</a></li>
          <li class="nav-item"><a class="nav-link" href="en-què-em-centro.html" data-translate="nav_focus">En què em centro</a></li>
          <li class="nav-item"><a class="nav-link" href="per-què-escollir-me.html" data-translate="nav_why">Per què escollir-me</a></li>
          <li class="nav-item"><a class="nav-link" href="esdeveniments.html" data-translate="nav_events">Esdeveniments</a></li>
          <li class="nav-item"><a class="nav-link" href="opinionse486.html" data-translate="nav_reviews">Opinions</a></li>
          <li class="nav-item"><a class="nav-link" href="preus.html" data-translate="nav_pricing">Preus</a></li>
          <li class="nav-item"><a class="nav-link" href="mashups.html" data-translate="nav_mashups">Mashups</a></li>
          <li class="nav-item"><a class="nav-link" href="configuracio.html" aria-label="Configuració">⚙️</a></li>
          <li class="nav-item" id="auth-container"></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <header class="hero" style="padding: 8rem 0;">
    <div class="container">
      <h1 class="display-4" data-translate="profile_title">El Meu Perfil</h1>
      <p class="lead" data-translate="profile_subtitle">Personalitza les teves preferències per a una millor experiència.</p>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="feature-card p-4">
          <div class="text-center mb-4 position-relative" id="photo-container" style="cursor: pointer; display: inline-block;">
            <img id="user-photo" src="Fotos/default-profile.png" alt="Foto de perfil" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
            <div class="position-absolute bottom-0 end-0 bg-primary rounded-circle p-1">
              <span style="font-size: 0.8rem;">✏️</span>
            </div>
            <input type="file" id="photoUpload" accept="image/*" style="display: none;">
            <div id="upload-feedback" class="form-text text-white-50 mt-2"></div>
            <h3 id="user-name" class="mt-2"></h3>
            <p id="user-email" class="text-white-50"></p>
          </div>
          <form id="profile-form">
            <div class="mb-3">
              <label for="displayName" class="form-label" data-translate="form_display_name">Nom a mostrar</label>
              <input type="text" class="form-control" id="displayName" required>
            </div>
            <div class="mb-3">
              <label for="favoriteGenre" class="form-label" data-translate="form_favorite_genre">Gènere Musical Preferit</label>
              <select class="form-select" id="favoriteGenre">
                <option value="reggaeton">Reggaeton</option>
                <option value="dembow">Dembow</option>
                <option value="techno">Techno</option>
                <option value="catalana">Música Catalana</option>
                <option value="pachangueo">Pachangueo</option>
                <option value="altres">Altres</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="userBio" class="form-label" data-translate="form_bio">Biografia Breu</label>
              <textarea class="form-control" id="userBio" rows="3" placeholder="Explica'ns una mica sobre tu..."></textarea>
            </div>
            <div class="mb-3">
              <label for="userInstagram" class="form-label" data-translate="form_instagram">Nom d'usuari d'Instagram</label>
              <input type="text" class="form-control" id="userInstagram" placeholder="el_teu_usuari">
            </div>
            <div class="form-check mb-4">
              <input class="form-check-input" type="checkbox" value="" id="emailNotifications">
              <label class="form-check-label" for="emailNotifications" data-translate="form_notifications_label">
                Vull rebre notificacions per correu sobre nous mashups i esdeveniments.
              </label>
            </div>
            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                <button type="submit" class="btn btn-primary" data-translate="form_save_button">Desar Canvis</button>
                <button type="button" id="sign-out-button" class="btn btn-danger" data-translate="form_signout_button">Tancar Sessió</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer mt-auto py-4">
    <div class="container d-md-flex justify-content-between align-items-center text-center text-md-start">
      <div class="mb-3 mb-md-0">
        <p class="mb-1">&copy; <span id="year"></span> DJ Posaxa. <span data-translate="footer_rights">Tots els drets reservats.</span></p>
        <p class="mb-1"><span data-translate="footer_location">Granollers · BCN</span></p>
        <div class="social-icons mt-2">
          <a href="https://www.tiktok.com/@djposaxa" target="_blank" rel="noopener" aria-label="TikTok"><img src="Fotos/Png tik.png" alt="TikTok" style="width: 24px; height: 24px;"></a>
          <a href="https://www.instagram.com/dj.posaxa/" target="_blank" rel="noopener" aria-label="Instagram"><img src="Fotos/pngwing.com.png" alt="Instagram" style="width: 24px; height: 24px;"></a>
        </div>
      </div>
      <div class="sigma-projects">
        <p class="mb-1"><span data-translate="footer_dev">Desenvolupat per Sigma Company</span></p>
        <p class="mb-2"><span data-translate="footer_more_projects">Més projectes de Sigma Company</span></p>
        <a href="http://www.sigmagames.ct.ws" class="btn btn-primary text-white" target="_blank" rel="noopener">SigmaGames</a>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getDatabase, ref, get, update } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAfNLKv-jNyyAaVrYSbwPnJKyNClDiF94Y",
      authDomain: "dj-posaxa-web.firebaseapp.com",
      databaseURL: "https://dj-posaxa-web-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dj-posaxa-web",
      storageBucket: "dj-posaxa-web.appspot.com",
      messagingSenderId: "647042791526",
      appId: "1:647042791526:web:3b870e05ab0ed34cbd95a7",
      measurementId: "G-C8R4Z4TLE1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const storage = getStorage(app);

    onAuthStateChanged(auth, user => {
      if (user) {
        // Sincronitzem les preferències per carregar el tema, idioma, etc. correctament
        window.syncPreferencesWithFirebase(auth, database, get, ref, update);

        document.getElementById('user-photo').src = user.photoURL || 'Fotos/default-profile.png';
        document.getElementById('user-name').textContent = user.displayName || 'Usuari';
        document.getElementById('user-email').textContent = user.email;

        // Carregar dades de perfil existents
        const userRef = ref(database, 'users/' + user.uid);
        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            document.getElementById('displayName').value = data.displayName || user.displayName;
            document.getElementById('favoriteGenre').value = data.favoriteGenre || 'reggaeton';
            document.getElementById('userBio').value = data.bio || '';
            document.getElementById('userInstagram').value = data.instagram || '';
            document.getElementById('emailNotifications').checked = data.preferences?.emailNotifications || false;
          } else {
            document.getElementById('displayName').value = user.displayName;
          }
        });

      } else {
        window.location.href = 'index.html';
      }
    });

    // Lògica per canviar la foto de perfil
    document.getElementById('photo-container').addEventListener('click', () => {
        document.getElementById('photoUpload').click();
    });

    document.getElementById('photoUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const user = auth.currentUser;
        const feedbackEl = document.getElementById('upload-feedback');

        if (!file || !user) return;

        // Validació del tipus d'arxiu i mida
        if (!file.type.startsWith('image/')) {
            feedbackEl.textContent = 'Si us plau, selecciona un arxiu d\'imatge.';
            return;
        }
        if (file.size > 5 * 1024 * 1024) { // 5 MB
            feedbackEl.textContent = 'La imatge és massa gran (màx. 5 MB).';
            return;
        }

        feedbackEl.textContent = 'Pujant imatge...';

        try {
            // 1. Crear una referència única per a l'arxiu
            const filePath = `profile_pictures/${user.uid}/${Date.now()}_${file.name}`;
            const fileRef = storageRef(storage, filePath);

            // 2. Pujar l'arxiu
            await uploadBytes(fileRef, file);

            // 3. Obtenir la URL de descàrrega
            const url = await getDownloadURL(fileRef);

            // 4. Actualitzar el perfil d'autenticació i la base de dades
            await updateProfile(user, { photoURL: url });
            await update(ref(database, 'users/' + user.uid), { photoURL: url });

            // 5. Actualitzar la UI
            document.getElementById('user-photo').src = url;
            feedbackEl.textContent = 'Foto actualitzada!';
            setTimeout(() => feedbackEl.textContent = '', 3000);
        } catch (error) {
            console.error("Error en pujar la imatge: ", error);
            feedbackEl.textContent = 'Error en pujar la imatge.';
        }
    });




    document.getElementById('profile-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (user) {
        const displayName = document.getElementById('displayName').value;
        const favoriteGenre = document.getElementById('favoriteGenre').value;
        const bio = document.getElementById('userBio').value;
        const instagram = document.getElementById('userInstagram').value;
        const emailNotifications = document.getElementById('emailNotifications').checked;

        // Dades del perfil
        const profileData = {
          displayName: displayName,
          email: user.email,
          bio: bio,
          instagram: instagram,
          photoURL: user.photoURL,
          favoriteGenre: favoriteGenre,
          lastLogin: new Date().toISOString(),
          role: 'cliente' // Assignació del rol per defecte
        };

        // Dades de preferències (per si s'actualitzen aquí)
        const preferencesData = {
            theme: localStorage.getItem('theme') || 'dark',
            fontSize: localStorage.getItem('fontSize') || 'normal',
            emailNotifications: emailNotifications
        };
        update(ref(database, 'users/' + user.uid), { ...profileData, preferences: preferencesData }).then(() => {
          alert('Perfil desat correctament!');
          window.location.href = 'index.html';
        }).catch((error) => {
          console.error("Error al desar les dades: ", error);
          alert('Hi ha hagut un error en desar el perfil.');
        });
      }
    });

    document.getElementById('sign-out-button').addEventListener('click', () => {
        signOut(auth).then(() => {
            window.location.href = 'index.html';
        }).catch(error => {
            console.error("Error en tancar sessió: ", error);
        });
    });

  </script>

  <!-- i18n & Theme Script -->
  <script src="assets/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      window.pageTranslations = {
        ca: {
          page_title: "El Meu Perfil — DJ Posaxa",
          profile_title: "El Meu Perfil",
          profile_subtitle: "Personalitza les teves preferències per a una millor experiència.",
          form_display_name: "Nom a mostrar",
          form_favorite_genre: "Gènere Musical Preferit",
          form_bio: "Biografia Breu",
          form_instagram: "Nom d'usuari d'Instagram",
          form_notifications_label: "Vull rebre notificacions per correu sobre nous mashups i esdeveniments.",
          form_save_button: "Desar Canvis",
          form_signout_button: "Tancar Sessió",
          footer_rights: "Tots els drets reservats.",
          footer_location: "Granollers · BCN",
          footer_dev: "Desenvolupat per Sigma Company",
          footer_more_projects: "Més projectes de Sigma Company"
        },
        // Pots afegir més traduccions aquí (es, en, fr, de)
      };
      initializePage(window.pageTranslations);
    });
  </script>

</body>
</html>